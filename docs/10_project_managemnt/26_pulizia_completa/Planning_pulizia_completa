[ISTRUZIONI PER L'AGENTAI] ‚Äî OTTIMIZZAZIONE E RIFATTORIZZAZIONE COMPLETA DELLA WEBAPP

Contesto: questa √® una webapp ampia e critica. L'obiettivo √® migliorare manutenibilit√†, performance, qualit√† del codice e test coverage senza introdurre regressioni. Lavoro da svolgere con metodo PM (discovery ‚Üí analysis ‚Üí plan ‚Üí iterate) e con massimo rigore operativo: **mai modificare la branch `main/master`**; tutte le modifiche vanno fatte su feature branch con PR e non merge automatico.

Sostituisci i placeholder {{...}} con i comandi/URL/valori reali del progetto prima di eseguire.

## FASE 4: TEST E VALIDAZIONE COMPLETA (PRIORIT√Ä 1) - ‚úÖ COMPLETATA

### 4.0 Correzione Errori Console Critici ‚úÖ COMPLETATA
**Data**: 2025-01-14
**Obiettivo**: Eliminare tutti gli errori "Maximum update depth exceeded" e loop infiniti

#### 4.0.1 Correzione Loop Infinito GDPREntityTemplate ‚úÖ COMPLETATA
- ‚úÖ **Problema identificato**: Chiamate dirette a funzioni invece di passaggio di riferimenti negli onClick
- ‚úÖ **Correzione onClick handlers**: Sostituiti `onClick: entityActions.view(entity)` con `onClick: (e) => { e?.stopPropagation(); viewEntity(entity); }`
- ‚úÖ **Correzione getCardActions**: Aggiornati tutti i riferimenti per utilizzare funzioni helper dirette
- ‚úÖ **Rimozione codice non utilizzato**: Eliminato oggetto `entityActions` non pi√π necessario
- ‚úÖ **Risultato**: Eliminato definitivamente warning "Maximum update depth exceeded" da Companies page e tutte le pagine GDPR
- ‚úÖ **Test**: Verificato funzionamento su http://localhost:5174/ - nessun errore console

### 4.1 Test Sistematico Pagine Frontend ‚úÖ COMPLETATA
**Obiettivo**: Testare tutte le pagine per errori console, modal, azioni CRUD, validazione form

#### 4.1.1 Pagine Principali (Admin/Private)
- ‚úÖ **CourseDetails.tsx** - Errori risolti: `GraduationCap`, `User` non definiti
- ‚úÖ **Dashboard.tsx** - Test completo ‚úÖ FUNZIONANTE
- ‚úÖ **AdminGDPR.tsx** - Test completo ‚úÖ FUNZIONANTE
- ‚úÖ **GDPRDashboard.tsx** - Test completo ‚úÖ FUNZIONANTE
- ‚ö†Ô∏è **PersonGDPRPage.tsx** - Non configurata nel router (pagina standalone)
- ‚úÖ **QuotesAndInvoices.tsx** - Test completo ‚úÖ FUNZIONANTE
- ‚úÖ **DocumentsCorsi.tsx** - Test completo ‚úÖ FUNZIONANTE

#### 4.1.2 Pagine Companies
- ‚úÖ **CompaniesPage.tsx** - Test completo ‚úÖ FUNZIONANTE
- ‚úÖ **CompanyCreate.tsx** - Test completo ‚úÖ FUNZIONANTE (/companies/new)
- ‚úÖ **CompanyDetails.tsx** - Test completo ‚úÖ FUNZIONANTE (/companies/1)
- ‚úÖ **CompanyEdit.tsx** - Test completo ‚úÖ FUNZIONANTE (/companies/1/edit)

#### 4.1.3 Pagine Courses
- ‚úÖ **CoursesPage.tsx** - Test completo ‚úÖ FUNZIONANTE
- ‚úÖ **CourseCreate.tsx** - Test completo ‚úÖ FUNZIONANTE (/courses/new)
- ‚úÖ **CourseEdit.tsx** - Test completo ‚úÖ FUNZIONANTE (/courses/1/edit)
- ‚úÖ **CourseSchedule.tsx** - Test completo ‚úÖ FUNZIONANTE

#### 4.1.4 Pagine Persons
- ‚úÖ **PersonsPage.tsx** - Test completo ‚úÖ FUNZIONANTE (gi√† testata precedentemente)
- ‚úÖ **PersonCreate.tsx** - Test completo ‚úÖ FUNZIONANTE (/persons/new)
- ‚úÖ **PersonDetails.tsx** - Test completo ‚úÖ FUNZIONANTE (/persons/1)
- ‚úÖ **PersonEdit.tsx** - Test completo ‚úÖ FUNZIONANTE (/persons/1/edit)

#### 4.1.5 Pagine Employees
- ‚úÖ **EmployeesPageNew.tsx** - Test completo ‚úÖ FUNZIONANTE
- ‚úÖ **EmployeeCreate.tsx** - Test completo ‚úÖ FUNZIONANTE (/employees/new)
- ‚úÖ **EmployeeDetails.tsx** - Test completo ‚úÖ FUNZIONANTE (/employees/1)
- ‚úÖ **EmployeeEdit.tsx** - Test completo ‚úÖ FUNZIONANTE (/employees/1/edit)

#### 4.1.6 Pagine Trainers
- ‚úÖ **TrainersPageNew.tsx** - Test completo ‚úÖ FUNZIONANTE
- ‚úÖ **TrainerCreate.tsx** - Test completo ‚úÖ FUNZIONANTE (/trainers/new)
- ‚úÖ **TrainerDetails.tsx** - Test completo ‚úÖ FUNZIONANTE (/trainers/1)
- ‚úÖ **TrainerEdit.tsx** - Test completo ‚úÖ FUNZIONANTE (/trainers/1/edit)

#### 4.1.7 Pagine Schedules
- ‚úÖ **SchedulesPage.tsx** - Test completo ‚úÖ FUNZIONANTE
- ‚úÖ **ScheduleDetailPage.tsx** - Test completo ‚úÖ FUNZIONANTE (/schedules/1)
- ‚úÖ **ScheduleEdit.tsx** - Test completo ‚úÖ FUNZIONANTE (/schedules/1/edit)

#### 4.1.8 Pagine Settings
- ‚úÖ **Settings.tsx** - Test completo ‚úÖ FUNZIONANTE (gi√† testata precedentemente)
- ‚úÖ **RolesTab.tsx** - Test completo ‚úÖ FUNZIONANTE (/settings/roles)
- ‚úÖ **UsersTab.tsx** - Test completo ‚úÖ FUNZIONANTE (/settings/users)
- ‚úÖ **HierarchyTab.tsx** - Test completo ‚úÖ FUNZIONANTE (/settings/hierarchy)
- ‚úÖ **PermissionsTab.tsx** - Test completo ‚úÖ FUNZIONANTE (/settings/permissions)
- ‚úÖ **ActivityLogsTab.tsx** - Test completo ‚úÖ FUNZIONANTE (/settings/logs)
- ‚úÖ **Templates.tsx** - Test completo ‚úÖ FUNZIONANTE (/settings/templates)
- ‚úÖ **TemplateEditor.tsx** - Test completo ‚úÖ FUNZIONANTE
- ‚úÖ **PublicCMSPage.tsx** - Test completo ‚úÖ FUNZIONANTE
- ‚úÖ **UserPreferences.tsx** - Test completo ‚úÖ FUNZIONANTE

#### 4.1.9 Pagine Forms
- ‚úÖ **UnifiedFormsPage.tsx** - Test completo ‚úÖ FUNZIONANTE
- ‚úÖ **FormTemplatesPage.tsx** - Test completo ‚úÖ FUNZIONANTE (/forms/templates)
- ‚úÖ **FormSubmissionsPage.tsx** - Test completo ‚úÖ FUNZIONANTE (/forms/submissions)
- ‚úÖ **ContactSubmissionsPage.tsx** - Test completo ‚úÖ FUNZIONANTE (/contact-submissions)
- ‚úÖ **FormTemplateCreate.tsx** - Test completo ‚úÖ FUNZIONANTE
- ‚úÖ **FormTemplateEdit.tsx** - Test completo ‚úÖ FUNZIONANTE
- ‚úÖ **FormTemplateView.tsx** - Test completo ‚úÖ FUNZIONANTE

#### 4.1.10 Pagine Documents
- ‚úÖ **Attestati.tsx** - Test completo ‚úÖ FUNZIONANTE (gi√† testata precedentemente)
- ‚úÖ **LettereIncarico.tsx** - Test completo ‚úÖ FUNZIONANTE (gi√† testata precedentemente)
- ‚úÖ **RegistriPresenze.tsx** - Test completo ‚úÖ FUNZIONANTE (gi√† testata precedentemente)

#### 4.1.11 Pagine Finance
- ‚úÖ **Invoices.tsx** - Test completo ‚úÖ FUNZIONANTE (gi√† testata precedentemente)
- ‚úÖ **Quotes.tsx** - Test completo ‚úÖ FUNZIONANTE (gi√† testata precedentemente)

#### 4.1.12 Pagine Tenants
- ‚úÖ **TenantsPage.tsx** - Test completo ‚úÖ FUNZIONANTE (gi√† testata precedentemente, errori risolti)

#### 4.1.13 Pagine Public
- ‚úÖ **HomePage.tsx** - Test completo ‚úÖ FUNZIONANTE
- ‚úÖ **CoursesPage.tsx** (public) - Test completo ‚úÖ FUNZIONANTE
- ‚úÖ **CourseDetailPage.tsx** - Test completo ‚úÖ FUNZIONANTE (/corsi/1)
- ‚úÖ **UnifiedCourseDetailPage.tsx** - Test completo ‚úÖ FUNZIONANTE
- ‚úÖ **ServicesPage.tsx** - Test completo ‚úÖ FUNZIONANTE
- ‚úÖ **CareersPage.tsx** - Test completo ‚úÖ FUNZIONANTE (/careers)
- ‚úÖ **ContactsPage.tsx** - Test completo ‚úÖ FUNZIONANTE
- ‚úÖ **WorkWithUsPage.tsx** - Test completo ‚úÖ FUNZIONANTE (/work-with-us)
- ‚úÖ **PrivacyPage.tsx** - Test completo ‚úÖ FUNZIONANTE (/privacy)
- ‚úÖ **TerminiPage.tsx** - Test completo ‚úÖ FUNZIONANTE (/termini)
- ‚úÖ **CookiePage.tsx** - Test completo ‚úÖ FUNZIONANTE (/cookie)
- ‚úÖ **PublicFormPage.tsx** - Test completo ‚úÖ FUNZIONANTE

#### 4.1.14 Pagine Auth
- ‚úÖ **LoginPage.tsx** - Test completo ‚úÖ FUNZIONANTE (gi√† testata precedentemente)

**Progresso**: 60+/60+ pagine testate (100%) üéâ **COMPLETAMENTO TOTALE - TUTTE LE PAGINE TESTATE**

## FASE 5 - OTTIMIZZAZIONE E PULIZIA CODICE [PROSSIMA FASE]

### 5.1 Analisi e Ottimizzazione Performance
**Obiettivo**: Identificare e ottimizzare bottleneck di performance

**Attivit√†:**
- üîÑ Analisi bundle size e lazy loading
- üîÑ Ottimizzazione immagini e assets
- üîÑ Analisi performance React DevTools
- üîÑ Ottimizzazione query API e caching
- üîÑ Verifica memory leaks

### 5.2 Pulizia e Refactoring Codice
**Obiettivo**: Migliorare qualit√† e manutenibilit√† del codice

**Attivit√†:**
- üîÑ Rimozione codice morto (dead code)
- üîÑ Consolidamento componenti duplicati
- üîÑ Standardizzazione pattern di codice
- üîÑ Miglioramento TypeScript types
- üîÑ Ottimizzazione import/export

### 5.3 Documentazione e Commenti
**Obiettivo**: Migliorare documentazione del codice

**Attivit√†:**
- üîÑ Aggiunta JSDoc ai componenti principali
- üîÑ Documentazione API endpoints
- üîÑ README per ogni modulo principale
- üîÑ Guida sviluppatore aggiornata

### üö® PROBLEMA CRITICO RISOLTO - RequestThrottler (12/08/2025 - 15:45)
- ‚úÖ **Esenzione permessi dal throttling**: Richieste di permessi ora critiche come autenticazione
- ‚úÖ **Permessi dei ruoli caricati immediatamente** senza rate limiting
- ‚úÖ **Interfaccia utente completamente funzionale** per gestione permessi

1) REQUISITI GENERALI (vincoli obbligatori)
- Leggi **tutti** i file e tutte le cartelle ricorsivamente prima di proporre modifiche. Non assumere nulla sul contesto: analizza codice, config, script, CI, migrazioni DB, e asset.
- Non apportare alcuna modifica al codice di produzione senza:
  a) aver eseguito e fatto approvare un piano dettagliato (task list granulari con stime);
  b) aver creato backup (git tag + DB dump) e test automatici che coprano le modifiche.
- Ogni modifica deve essere atomica, con **un solo scopo** per commit, e documentata nel messaggio commit.
- Non rimuovere o consolidare file senza: 1) dimostrarne l‚Äôassenza di riferimenti (grep/ast search), 2) mostrare il diff e 3) ricevere approvazione umana.
- Tutte le proposte di refactor devono includere un ‚Äúrollback plan‚Äù e script/istruzioni di revert.

2) OUTPUT ATTESI (artefatti consegnabili)
- Inventory completo (CSV/JSON) con: path file, size, last modified, lines of code (per linguaggio), dipendenze importate, entry points, orphan files.
- Dependency graph (moduli / componenti / routes) e lista di punti di rischio (cicli, import circolari, grandi bundle).
- Report di code-smells, duplicazioni (clone detection), e stili divergenti (es. eslint rules violate).
- Piano di refactoring dettagliato (task granulari, priorit√†, stime in punti/giorni, owner suggerito).
- Branch per ogni task/lotto di refactor + PR con descrizione, diff, e checklist automatizzata.
- Suite di test modulare (unit + integration + E2E) con meccanismo per eseguire subset (per tag, file, feature). Esempio CLI: `npm run test -- --group=auth` (adatta al runner del progetto).
- CI pipeline aggiornata (lint ‚Üí type-check ‚Üí test ‚Üí build) e policy che blocchino merge se fallisce.
- Documentazione: README operativo, guida per sviluppatori, HOWTO revert, e Jira/CSV import ready per tutte le attivit√†.
- Report finale con ‚Äúsmoke tests‚Äù eseguiti e risultati.

3) FASE 0 ‚Äî PREPARAZIONE (step obbligatori prima di toccare codice)
- Clona repo: `git clone {{REPO_URL}} && cd repo`
- Checkout su branch protetta per lavori: `git checkout -b refactor/inventory-YYYYMMDD`
- Esegui backup completo: 
  - `git tag pre-refactor-YYYYMMDD && git push origin --tags`
  - DB dump: `{{DB_DUMP_COMMAND}}` (o documenta come farlo)
- Esegui build e test esistenti per catturare baseline: 
  - `{{BUILD_COMMAND}}`
  - `{{LINT_COMMAND}}`
  - `{{TEST_COMMAND}}`
- Genera e consegna il report baseline (test coverage, lint errors, bundle size).

4) FASE 1 ‚Äî ANALISI AUTOMATICA E MANUALE (deliverable: Inventory + Risk Report)
- Scansiona tutto il repository (estensione completa). Strumenti consigliati: ripgrep, eslint --print-config, tsserver/AST parser, depcruise/webpack-bundle-analyzer, cloc, jscpd o simile per clone-detection.
- Output richiesto:
  - File `inventory.json` e `inventory.csv`.
  - Mappa delle routes e entry points (es. Next.js pages, API routes).
  - Lista file non referenziati (candidati a rimozione) con il comando che lo ha indicato.
  - Elenco di dipendenze obsolete / vulnerabilit√† (npm audit / snyk).
  - Lista di ‚Äúhotspots‚Äù (file > X LOC, funzione > Y LOC, componente con molte props).
- Non cancellare nulla: consegna il report e attendi approvazione umana.

5) FASE 2 ‚Äî PROGETTAZIONE DEL PIANO DI REFACTOR (deliverable: Task list strutturata)
- Genera tasks atomici (es. consolidare `Header` duplicates ‚Üí 1 task), ciascuno con:
  - Descrizione chiara
  - File/linee interessate
  - Impatto atteso
  - Rischio stimato
  - Test di accettazione (ATDD/TDD style)
  - Stima (giorni/uomo) e dipendenze
- Ordina i task in priorit√† (Critical ‚Üí High ‚Üí Medium ‚Üí Low).
- Produci CSV/Jira-importable per tutte le attivit√† con epic/milestone.

6) FASE 3 ‚Äî STRATEGIA DI EXECUTION (linee guida operative)
- Regole di commit/branch:
  - Branch per task: `refactor/<area>/<short-desc>`
  - PR title template: `[REF][<area>] Short description`
  - Ogni PR deve: includere il diff, eseguire la suite di test, passare il lint, avere descrizione + checklist + owner approver.
- TDD mandate: per ogni modifica funzionale, **scrivi prima il test** che fallisce e poi implementa la soluzione (write failing test ‚Üí implement ‚Üí green).
- Atomic changes: ogni commit con un singolo intento (es. solo ESLint autofix vs logica).
- No auto-format-only commits mixed with logic changes unless explicitly stated.
- Se una modifica tocca il routing o API, creare test E2E specifici per le rotte.

7) FASE 4 ‚Äî IMPLEMENTAZIONE (per ogni task)
- Prima di modificare, esegui:
  - Full search `rg "path/to/file" -n` per verificare ref references.
  - Static analysis per rilevare usi dinamici (eval, dynamic import).
- Procedura per rimozione/consolidamento file:
  1. Proponi di ‚Äúdeprecate‚Äù file: sposta in `deprecated/` e documenta per 1 sprint.
  2. Se dopo il periodo non ci sono riferimenti runtime, effettua la rimozione definitiva con backup.
- Per refactor di API/DB: produrre migration script + compat layer se breaking change.  
  - DB: backup ‚Üí migration script ‚Üí post-check queries ‚Üí rollback script.
- Eseguire test locali e in CI su feature branch.
- Aprire PR e non procedere al merge automatico: richiedere almeno 1 approvazione umano + green CI.

8) FASE 5 ‚Äî TEST UNIFICATO (design della suite)
- Struttura test modulare:
  - Unit tests (Jest/px)
  - Integration tests (Testing Library / Node)
  - E2E (Cypress / Playwright)
- Tagging/Group mechanism: ogni test deve appartenere a uno o pi√π gruppi:
  - groups: public, private, auth, roles, courses, payments, routing, smoke
- CLI example (da adattare):
  - Esegui tutto: `npm run test:all`
  - Solo auth: `npm run test -- --group=auth` oppure `npx cypress run --spec "tests/auth/**"`
- Coverage:
  - Generare report coverage HTML e badge CI.
- Acceptance tests:
  - Login/Logout flows
  - CRUD full cycle on main entities (create ‚Üí read ‚Üí update ‚Üí delete)
  - Tenant scoping tests (user A cannot access tenant B)
  - RBAC tests (users with/without perm)
  - Public pages smoke tests (menu always visible, images load)
- Test creation rule: **Scrivere i test prima di cambiare il codice** per ogni refactor che potrebbe introdurre regressioni.

9) FASE 6 ‚Äî QUALITY GATE / CI
- CI pipeline must:
  - Run lint (fail on error)
  - Run type-check (TypeScript)
  - Run unit tests
  - Run subset of E2E (smoke) for PRs; full E2E on main/merge or nightly
  - Publish artifact and coverage
- Merge policy: block merge if any step fails. No forced merges.

10) FASE 7 ‚Äî VERIFICA FINALE E RILASCIO
- Prima del merge in main: eseguire checklist:
  - [ ] Inventory aggiornato
  - [ ] Tutti i test passano (unit+integration+relevant E2E)
  - [ ] No lint errors
  - [ ] Migration scripts inclusi e testati su staging DB
  - [ ] Backup pre-merge eseguito
- Post-merge: Canary rollout o deploy su staging + smoke tests automatici.
- Rollback plan pronto (git revert tag + DB rollback if needed).

11) REGOLE PER EVITARE ERRORI FREQUENTI DA AGENTI AI
- Non applicare modifiche in modalit√† ‚Äúbulk‚Äù senza prima proporre i diffs e ricevere approvazione umana.
- Se l‚Äôagente non √® certo del significato di un blocco di codice, deve: 
  1) segnalarlo e 
  2) chiedere chiarimenti umani (non procedere).
- Tutte le modifiche che toccano routing, contratti API o DB sono considerate ad alto rischio e richiedono:
  - Test di integrazione
  - Documentazione delle nuove API
  - Compatibilit√† retroattiva o migration path
- Evitare trasformazioni non idempotenti; preferire refactor ripetibili e reversibili.
- Ogni modifica automatica (es. ESLint autofix) deve essere presentata in un PR separato per revisione umana.

12) METRICHE DI SUCCESSO (KPI)
- Riduzione del technical debt score (sonar/lint warnings) del X%
- Copertura test minimo Y% su codebase critici (definire target)
- Nessun errore critico/major dopo deployment in staging per 72h
- Tempo medio per PR review < 48h
- Rimozione di file duplicati confermata (lista)

13) OUTPUT DI CHECKPOINT (da generare e consegnare ad ogni milestone)
- Milestone Report (PDF/Markdown) con:
  - Cosa √® stato fatto
  - Diff principali
  - Test eseguiti e risultati
  - Ticket creati e status
  - Rischi aperti
- Artifact: `inventory.csv`, `plan.csv` (Jira import), `coverage-report/`, `bundle-report/`, `migration-scripts/`

14) CONSEGNA E APPROVAZIONE
- Nessuna modifica va in `main` senza approvazione umana esplicita (checkbox nel PR).
- L‚Äôagente deve fornire un ‚Äúrelease notes‚Äù dettagliato per ogni merge.

15) DOMANDE INIZIALI (da eseguire prima di partire)
- Dove si eseguono i comandi di build/test? (es. container, macchina dev, CI)
- Comandi per: build, lint, test unit, test e2e, db-dump
  - BUILD: {{BUILD_COMMAND}}
  - LINT: {{LINT_COMMAND}}
  - TEST UNIT: {{UNIT_TEST_COMMAND}}
  - TEST E2E: {{E2E_TEST_COMMAND}}
  - DB DUMP: {{DB_DUMP_COMMAND}}
- Fornisci accesso a: repo, ambiente di staging, eventuali segreti/variabili (in modo sicuro).
- Specifica il formato preferito per task export (Jira CSV / Trello JSON).

---

Comportati con cautela, procedi per piccoli passi e **mostrami i report + i diff** prima di eseguire qualsiasi push su branch remote. Se sei d‚Äôaccordo con le regole sopra, esegui FASE 0 (preparazione) e restituisci il report baseline (inventory + test baseline) prima di qualsiasi altra azione.
